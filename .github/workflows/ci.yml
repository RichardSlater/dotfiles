---
name: CI

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck (Bash files)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck on bash files
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          additional_files: 'dot_bashrc dot_profile'
          # Exclude zsh-only files and ansible scripts
          ignore_paths: 'dot_zshrc dot_zshenv dot_config/dot_fzf.zsh dot_config/zsh_aliases dot_config/zsh_keybinds scripts/ansible'
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: '.'

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install ansible and ansible-lint
        run: pip install ansible ansible-lint

      - name: Install Ansible Galaxy requirements
        working-directory: scripts/ansible
        run: ansible-galaxy install -r requirements.yml

      - name: Run ansible-lint
        working-directory: scripts/ansible
        run: ansible-lint playbook.yml
        continue-on-error: true  # Allow warnings without failing the build

  chezmoi-validate:
    name: Chezmoi Template Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install chezmoi
        run: sh -c "$(curl -fsLS get.chezmoi.io)"

      - name: Initialize chezmoi with source
        run: ./bin/chezmoi init --source="${{ github.workspace }}"
        env:
          # Provide minimal config for template rendering
          CHEZMOI_EMAIL: "ci@example.com"

      - name: Validate templates (dry-run)
        run: ./bin/chezmoi diff --dry-run || true

      - name: Run chezmoi doctor
        run: ./bin/chezmoi doctor || true
