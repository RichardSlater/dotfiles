---
- name: Install dependencies for tmux build
  become: true
  apt:
    name:
      - build-essential
      - autoconf
      - automake
      - pkg-config
      - libevent-dev
      - libncurses5-dev
      - libncursesw5-dev
      - bison
      - git
      - wget
      - jq
    state: present
  when: ansible_facts['os_family'] == "Debian"

- name: Create source directory
  file:
    path: "{{ tmux_src_dir }}"
    state: directory
    mode: "0755"

- name: Download tmux source code
  get_url:
    url: "https://github.com/tmux/tmux/releases/download/{{ tmux_version }}/tmux-{{ tmux_version }}.tar.gz"
    dest: "{{ tmux_src_dir }}/tmux.tar.gz"
    checksum: "{{ tmux_checksum }}"

- name: Extract tmux source
  ansible.builtin.unarchive:
    src: "{{ tmux_src_dir }}/tmux.tar.gz"
    dest: "{{ tmux_src_dir }}"
    remote_src: true
    extra_opts: [--strip-components=1]

- name: Ensure correct permissions for source directory
  file:
    path: "{{ tmux_src_dir }}"
    state: directory
    mode: "0755"
    recurse: true

- name: Run autogen.sh to prepare the build system
  command:
    cmd: "./autogen.sh"
    chdir: "{{ tmux_src_dir }}"
  args:
    creates: "{{ tmux_src_dir }}/configure"

- name: Configure tmux build
  command:
    cmd: "./configure --prefix={{ tmux_install_dir }}"
    chdir: "{{ tmux_src_dir }}"
  args:
    creates: "{{ tmux_src_dir }}/Makefile"

- name: Compile tmux
  command:
    cmd: "make"
    chdir: "{{ tmux_src_dir }}"
  args:
    creates: "{{ tmux_src_dir }}/tmux"

- name: Install tmux
  become: true
  command:
    cmd: "make install"
    chdir: "{{ tmux_src_dir }}"

- name: Verify tmux installation
  command: "{{ tmux_install_dir }}/bin/tmux -V"
  register: tmux_version_output
  changed_when: false

- name: Show installed tmux version
  debug:
    msg: "Installed tmux version: {{ tmux_version_output.stdout }}"
