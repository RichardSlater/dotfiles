---
- name: Debugging
  hosts: localhost
  tasks:
    - name: Operating System Family
      ansible.builtin.debug:
        var: ansible_facts['os_family']
    - name: Operating System Version
      ansible.builtin.debug:
        var: ansible_facts['distribution_version']
    - name: Debian is > 13
      ansible.builtin.debug:
        var: ansible_facts['distribution_version'] is version('13.0', '>=')

- name: Update Ubuntu/Debian system
  hosts: localhost
  become: true
  tasks:
    - name: Update and upgrade system with recovery
      block:
        - name: Update apt package index
          apt:
            update_cache: true

        - name: Upgrade all packages
          apt:
            upgrade: full

        - name: Remove unnecessary packages
          apt:
            autoremove: true
            autoclean: true

        - name: Install dependant packages
          apt:
            name: "{{ item }}"
            state: present
          loop:
            - python3-debian
            - git
            - wget
            - curl

      rescue:
        - name: Remove extra librhash1 that gets picked up incorrectly
          ansible.builtin.command: sudo dpkg --remove --force-all librhash1
          ignore_errors: true

        - name: Fix broken apt installs
          ansible.builtin.command: apt-get install --fix-broken -y
          register: fix_broken_result
          ignore_errors: true

        - name: Retry update apt package index
          apt:
            update_cache: true

        - name: Retry upgrade all packages
          apt:
            upgrade: full

        - name: Retry remove unnecessary packages
          apt:
            autoremove: true
            autoclean: true

- name: Run roles for system setup
  hosts: localhost
  become: true
  vars:
    packages:
      - dnsutils
      - btop
      - yamllint
      - jq
      - ripgrep
      - shellcheck
      - pre-commit
      - libclang-dev
    unlisted_packages:
      - name: Dive
        source: https://github.com/wagoodman/dive/releases/download/v0.13.1/dive_0.13.1_linux_amd64.deb
    # geerlingguy.go role variables - Go 1.25.4 (latest stable as of Nov 2025)
    go_version: "1.25.4"
    go_install_clean: true
    go_checksum: "9fa5ffeda4170de60f67f3aa0f824e426421ba724c21e133c1e35d6159ca1bec"
  roles:
    - packages
    - bat
    - fzf
    - geerlingguy.go
    - gh
    - neovim
    - oh-my-posh
    - pwsh
    - tmux
    - zsh
    - wsl
    - podman

- name: Run roles for user setup
  hosts: localhost
  vars:
    rustup_user: "{{ ansible_facts['user_id'] }}"
  roles:
    - rootless-networking
    - nvm
    - hurricanehrndz.rustup
    - cargo
    - uv
    - speckit

- name: Update Neovim Plugins (LazyVim)
  hosts: localhost
  tasks:
    - name: Check if nvim is installed
      command: which nvim
      register: nvim_check
      ignore_errors: true
      changed_when: false

    - name: Run LazyVim sync
      command: nvim --headless "+Lazy! sync" +qa
      when: nvim_check.rc == 0
      register: lazy_sync
      changed_when: "'No updates' not in lazy_sync.stdout"
      ignore_errors: true

- name: Run roles for user
  hosts: localhost
  roles:
    - role: foundry
      when: "'ensono.com' not in ansible_facts['dns'].search"
    - container-cleanup
